{% extends "base.html" %}

{% block content %}
    <div id="view-dashboard" class="view-section active">
        <h2 style="margin-bottom: 24px; color: var(--text-main);">System Status</h2>
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header"><span>CPU & RAM</span></div>
                <div class="card-body">
                    <div class="status-row"><span>CPU Usage</span><span id="cpu-val">0%</span></div>
                    <div class="progress-container"><div id="cpu-bar" class="progress-fill" style="width: 0%; background: var(--text-main);"></div></div>
                    <div class="status-row"><span>RAM Usage</span><span id="ram-val">0%</span></div>
                    <div class="progress-container"><div id="ram-bar" class="progress-fill" style="width: 0%; background: var(--text-muted);"></div></div>
                    <div style="height: 100px; margin-top:10px;"><canvas id="sysChart"></canvas></div>
                </div>
            </div>
            <div class="card widget-wide">
                <div class="card-header"><span>Traffic Volume</span></div>
                <div class="card-body"><canvas id="trafficChart"></canvas></div>
            </div>
            <div class="card">
                <div class="card-header"><span>Threat Consensus</span></div>
                <div class="card-body"><div style="height:180px;"><canvas id="threatChart"></canvas></div></div>
            </div>
            <div class="card widget-wide">
                <div class="card-header"><span>Incoming Files</span></div>
                <div class="card-body" style="padding:0;">
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; gap:8px;">
                        <div style="font-weight:600; color:var(--text-main);">Upload PCAP</div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input id="pcapUploadInput" type="file" accept=".pcap,.pcapng" style="display:none;" onchange="uploadPcap(event)">
                            <button class="btn" onclick="document.getElementById('pcapUploadInput').click()"><i class="fas fa-upload"></i> Upload PCAP</button>
                        </div>
                    </div>
                    <table style="margin:0;">
                        <thead><tr><th>Filename</th><th>Size</th><th>Status</th></tr></thead>
                        <tbody id="filesTableDashboard" style="cursor: pointer;"></tbody>
                    </table>
                </div>
            </div>
            <div class="card widget-wide">
                <div class="card-header"><span>Top 5 Flows by Traffic</span></div>
                <div class="card-body" style="padding:0; height:auto; max-height:300px; overflow-y:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <thead style="position:sticky; top:0; background:var(--bg-secondary);">
                            <tr>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Src IP</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Src Port</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Dst IP</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Dst Port</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Protocol</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Total Traffic</th>
                            </tr>
                        </thead>
                        <tbody id="topFlowsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="view-flows" class="view-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="margin: 0; color: var(--text-main);">Flows Summary</h2>
            <button class="btn" onclick="loadFlowsSummary()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="card">
                <div class="card-header"><span>IP Summary (Top 10)</span></div>
                <div class="card-body"><canvas id="ipSummaryChart"></canvas></div>
            </div>
            <div class="card">
                <div class="card-header"><span>Flow Statistics</span></div>
                <div class="card-body">
                    <div class="status-row"><span>Total Flows</span><span id="totalFlowsCount" style="font-weight:800; font-size:1.2em;">0</span></div>
                    <div style="margin-top:12px; padding:12px; background:var(--bg-secondary); border-radius:4px;">
                        <div class="status-row"><span>Attack Flows</span><span id="attackFlowsCount" style="font-weight:800; font-size:1.2em; color:#ef4444;">0</span></div>
                    </div>
                    <div style="margin-top:12px;">
                        <div style="font-weight:600; margin-bottom:8px; color:var(--text-main);">Top Protocols</div>
                        <div id="protocolList" style="font-size:0.9em;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Consensus Voting Logs Section -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <span><i class="fas fa-gavel" style="margin-right: 8px;"></i>Consensus Voting Logs</span>
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="loadConsensusLogs()" style="font-size: 0.85em; padding: 6px 12px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn" style="font-size: 0.85em; padding: 6px 12px; background: #ef4444;" onclick="clearConsensusLogs()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <!-- Filter Panel -->
                <div style="padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <input id="consensusSearchInput" type="text" placeholder="Search..." style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; width: 200px;">
                        <select id="consensusResultFilter" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                            <option value="">All Results</option>
                            <option value="attack">Attack</option>
                            <option value="benign">Benign</option>
                        </select>
                        <select id="consensusVotesFilter" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                            <option value="">All Votes</option>
                            <option value="1">≥1 vote</option>
                            <option value="2">≥2 votes</option>
                            <option value="3">≥3 votes</option>
                            <option value="4">≥4 votes</option>
                            <option value="5">≥5 votes</option>
                            <option value="6">6 votes (All agree)</option>
                        </select>
                        <button class="btn" onclick="applyConsensusFilters()" style="font-size: 0.85em; padding: 6px 12px;">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button class="btn" onclick="clearConsensusFilters()" style="font-size: 0.85em; padding: 6px 12px;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                <!-- Table -->
                <div style="height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 10;">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); width: 50px;">#</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortConsensusLogs('time')">Time <span id="consensusSortTime"></span></th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortConsensusLogs('file')">File <span id="consensusSortFile"></span></th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortConsensusLogs('srcip')">Src IP <span id="consensusSortSrcip"></span></th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Src Port</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortConsensusLogs('dstip')">Dst IP <span id="consensusSortDstip"></span></th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Dst Port</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortConsensusLogs('votes')">Votes <span id="consensusSortVotes"></span></th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortConsensusLogs('source')">Source <span id="consensusSortSource"></span></th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortConsensusLogs('result')">Result <span id="consensusSortResult"></span></th>
                            </tr>
                        </thead>
                        <tbody id="consensusLogsBody"></tbody>
                    </table>
                </div>
                <!-- Pagination -->
                <div style="padding: 12px; display: flex; justify-content: center; gap: 8px; align-items: center; border-top: 1px solid var(--border-color);">
                    <button class="btn" id="consensusPrevBtn" onclick="consensusPrevPage()" disabled style="font-size: 0.85em;">&lt; Prev</button>
                    <span id="consensusPageDisplay" style="font-size: 0.9em;">Page 1 / 1</span>
                    <button class="btn" id="consensusNextBtn" onclick="consensusNextPage()" disabled style="font-size: 0.85em;">Next &gt;</button>
                </div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="card widget-wide">
                <div class="card-header"><span>Attack Flow Details (Latest 10)</span></div>
                <div class="card-body" style="padding:0; height:400px; overflow-y:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <thead style="position:sticky; top:0; background:var(--bg-secondary);">
                            <tr>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Src IP</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Src Port</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Dst IP</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Dst Port</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Protocol</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">Threat Type</th>
                                <th style="padding:8px; text-align:left; border-bottom:1px solid var(--border-color);">File</th>
                            </tr>
                        </thead>
                        <tbody id="attackFlowsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="view-incoming-files" class="view-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="margin: 0; color: var(--text-main);">Incoming Files</h2>
            <div style="display: flex; gap: 8px;">
                <button class="btn" onclick="loadIncomingFiles()"><i class="fas fa-sync-alt"></i> Refresh</button>
                <input id="pcapUploadInputIncoming" type="file" accept=".pcap,.pcapng" style="display:none;" onchange="uploadPcap(event)">
                <button class="btn" onclick="document.getElementById('pcapUploadInputIncoming').click()"><i class="fas fa-upload"></i> Upload PCAP</button>
            </div>
        </div>

        <!-- PCAP Filter Panel -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <i class="fas fa-filter"></i> Search & Filter
                <button style="float:right; background:none; border:none; cursor:pointer; color:var(--text-main);" onclick="togglePcapFilters()">
                    <i id="pcapFilterToggleIcon" class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div id="pcapFiltersPanel" class="card-body" style="display:block; padding:16px; border-top: 1px solid var(--border-color);">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 12px;">
                    <!-- Global Search -->
                    <div>
                        <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9em;">Search</label>
                        <input type="text" id="pcapSearchInput" placeholder="File name, status..." style="width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; background:var(--bg-main); color:var(--text-main);" onkeyup="pcapApplyFilters()">
                    </div>
                    
                    <!-- Filter by Name -->
                    <div>
                        <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9em;">Filename</label>
                        <input type="text" id="pcapFilterName" placeholder="e.g., synscan" style="width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; background:var(--bg-main); color:var(--text-main);" onchange="pcapApplyFilters()">
                    </div>
                    
                    <!-- Filter by Status -->
                    <div>
                        <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9em;">Status</label>
                        <select id="pcapFilterStatus" style="width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; background:var(--bg-main); color:var(--text-main);" onchange="pcapApplyFilters()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="done">Done</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    
                    <!-- Filter by Threat Level -->
                    <div>
                        <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9em;">Threat Level</label>
                        <select id="pcapFilterThreat" style="width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; background:var(--bg-main); color:var(--text-main);" onchange="pcapApplyFilters()">
                            <option value="">All Files</option>
                            <option value="threat">Threat Only</option>
                            <option value="safe">Safe Only</option>
                        </select>
                    </div>

                    <!-- Sort By -->
                    <div>
                        <label style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9em;">Sort By</label>
                        <select id="pcapSortBy" style="width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; background:var(--bg-main); color:var(--text-main);" onchange="pcapApplyFilters()">
                            <option value="upload_date">Upload Date</option>
                            <option value="name">Filename</option>
                            <option value="size">File Size</option>
                            <option value="status">Status</option>
                            <option value="flows">Total Flows</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 8px; align-items: flex-end;">
                        <button class="btn" style="flex:1;" onclick="pcapResetFilters()"><i class="fas fa-undo"></i> Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body" style="padding:0;">
                <table style="margin:0;">
                    <thead>
                        <tr>
                            <th onclick="pcapSortChange('name')" style="cursor:pointer;">
                                Filename
                                <span id="pcapSortName"></span>
                            </th>
                            <th onclick="pcapSortChange('size')" style="cursor:pointer;">
                                Size
                                <span id="pcapSortSize"></span>
                            </th>
                            <th onclick="pcapSortChange('status')" style="cursor:pointer;">
                                Status
                                <span id="pcapSortStatus"></span>
                            </th>
                            <th onclick="pcapSortChange('upload_date')" style="cursor:pointer;">
                                Upload Date
                                <span id="pcapSortDate"></span>
                            </th>
                            <th onclick="pcapSortChange('flows')" style="cursor:pointer;">
                                Flows
                                <span id="pcapSortFlows"></span>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="filesTableIncoming" style="cursor: pointer;"></tbody>
                </table>
            </div>
        </div>
        <div id="fileDetailsPanel" class="slide-overlay" onclick="closeFileDetails()" style="display:none;"></div>
    </div>

    <div id="view-settings" class="view-section">
        <h2 style="margin-bottom: 24px; color: var(--text-main);">Admin Settings</h2>
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header"><i class="fas fa-user-edit"></i> Profile</div>
                <div class="card-body">
                    <form id="profileForm">
                        <div class="setting-group" style="text-align:center; border:none;">
                            <img src="{{ url_for('static', filename='avatars/admin_default.png') }}" id="setting-avatar" style="width:100px; height:100px; border-radius:50%; object-fit:cover; margin-bottom:15px; border:3px solid var(--text-main);">
                            <br>
                            <label class="btn" for="avatarUpload" style="cursor:pointer; font-size:0.8em;"><i class="fas fa-camera"></i> Change Avatar</label>
                            <input type="file" id="avatarUpload" name="avatar" accept="image/*" style="display:none;" onchange="previewAvatar(event)">
                        </div>
                        <div class="setting-group">
                            <label style="display:block; margin-bottom:8px; font-weight:600;">Display Name</label>
                            <input type="text" class="form-input" id="setting-fullname" name="full_name">
                        </div>
                        <div class="setting-group">
                            <label style="display:block; margin-bottom:8px; font-weight:600;">Theme</label>
                            <div style="display:flex; gap:12px; align-items:center;">
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                    <input type="radio" id="themeLight" name="theme" value="light" style="cursor:pointer;">
                                    <i class="fas fa-sun"></i> Light
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                    <input type="radio" id="themeDark" name="theme" value="dark" style="cursor:pointer;">
                                    <i class="fas fa-moon"></i> Dark
                                </label>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="updateProfile()" style="width:100%;">Save Profile</button>
                    </form>
                </div>
            </div>
            
            <!-- Login History Card -->
            <div class="card widget-wide">
                <div class="card-header">
                    <span><i class="fas fa-history"></i> Login History</span>
                    <button class="btn" style="padding: 4px 10px; font-size: 0.8em;" onclick="loadUserLoginHistory()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body" style="padding: 0; max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 1;">
                            <tr>
                                <th style="padding: 10px 12px; text-align: left; font-size: 0.85em;">Time</th>
                                <th style="padding: 10px 12px; text-align: left; font-size: 0.85em;">Action</th>
                                <th style="padding: 10px 12px; text-align: left; font-size: 0.85em;">IP Address</th>
                                <th style="padding: 10px 12px; text-align: left; font-size: 0.85em;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="loginHistoryBody">
                            <tr>
                                <td colspan="4" style="padding: 20px; text-align: center; color: var(--text-muted);">
                                    <i class="fas fa-spinner fa-spin"></i> Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div style="height: 32px;"></div>
        
        <h2 style="margin-bottom: 24px; color: var(--text-main); margin-top: 40px; padding-top: 24px; border-top: 1px solid var(--border-color);">System Configuration</h2>
        
        <div class="card">
            <div class="card-header">Detection Settings</div>
            <div class="card-body" style="padding: 0;">
                <!-- IPS Engine Row -->
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <div style="font-weight: 600; font-size: 0.95em; margin-bottom: 3px;">IPS Engine</div>
                        <div style="font-size: 0.8em; color: var(--text-muted);">TLS Fingerprint detection (JA3, JA3S, SNI)</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span id="ipsStatus" style="font-weight: 500; font-size: 0.9em; color: var(--text-muted);">Enabled</span>
                        <label class="switch">
                            <input type="checkbox" id="ipsToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- Detection Mode Row -->
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <div style="font-weight: 600; font-size: 0.95em; margin-bottom: 3px;">Detection Mode</div>
                        <div style="font-size: 0.8em; color: var(--text-muted);">ML model ensemble strategy</div>
                    </div>
                    <select id="modeSelector" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85em; background: var(--bg-secondary); color: var(--text-body); cursor: pointer; min-width: 180px;" onchange="onDetectionModeChange()">
                        <option value="voting">Voting Mode (6 Models)</option>
                        <option value="rf_only">RF Only (Fast)</option>
                    </select>
                </div>
                
                <!-- Voting Threshold Row -->
                <div id="thresholdContainer" style="padding: 16px 24px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; font-size: 0.95em; margin-bottom: 3px;">Voting Threshold</div>
                            <div style="font-size: 0.8em; color: var(--text-muted);">Minimum votes to classify as threat (out of 6)</div>
                        </div>
                        <div style="text-align: center; min-width: 50px;">
                            <span id="thresh-display" style="font-weight: 700; font-size: 1.3em; color: var(--text-main);">2</span>
                            <span style="font-size: 0.8em; color: var(--text-muted);">/6</span>
                        </div>
                    </div>
                    <input type="range" id="threshSlider" min="1" max="6" value="2" 
                           style="width: 100%; height: 6px; border-radius: 3px; background: var(--border-color); outline: none; -webkit-appearance: none; cursor: pointer;" 
                           oninput="document.getElementById('thresh-display').textContent = this.value">
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75em; color: var(--text-muted);">
                        <span>Sensitive (1)</span>
                        <span>Balanced (3)</span>
                        <span>Conservative (6)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Apply Configuration Button -->
        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
            <button class="btn btn-primary" onclick="saveSystemSettings()" style="padding: 10px 24px; font-size: 0.9em;">
                <i class="fas fa-save"></i> Apply Configuration
            </button>
        </div>
    </div>

    <div id="view-model" class="view-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 id="model-title" style="margin: 0;">Model Name</h2>
            <button class="btn" onclick="resetPagination()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
        <div style="margin-bottom: 12px;">
            <div style="display: flex; gap: 8px; align-items: center;">
                <i class="fas fa-search" style="color: var(--text-muted);"></i>
                <input id="globalSearchInput" type="text" placeholder="Search logs..." style="flex:1; padding:8px 12px; border:1px solid var(--border-color); border-radius:4px; font-size:0.9em;">
                <button class="btn" onclick="applyFilters()"><i class="fas fa-filter"></i> Filter</button>
                <button class="btn" onclick="clearAllFilters()"><i class="fas fa-times"></i> Clear Filter</button>
                <div style="position: relative; display: inline-block;">
                    <button class="btn" style="background: #ef4444;" onclick="toggleClearLogsMenu()" title="Clear logs options"><i class="fas fa-trash"></i> Clear Logs <i class="fas fa-chevron-down" style="font-size:0.8em; margin-left:4px;"></i></button>
                    <div id="clearLogsMenu" style="position: absolute; top: 100%; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; min-width: 220px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; display: none; margin-top: 4px;">
                        <div style="padding: 8px; border-bottom: 1px solid var(--border-color);">
                            <button class="btn" style="width: 100%; background: #ef4444; justify-content: flex-start;" onclick="clearFilteredLogs(); toggleClearLogsMenu()">
                                <i class="fas fa-filter"></i> Clear Filtered Logs
                            </button>
                        </div>Vo
                        <div style="padding: 8px; border-bottom: 1px solid var(--border-color);">
                            <button class="btn" style="width: 100%; background: #f97316; justify-content: flex-start;" onclick="clearAllCurrentModel(); toggleClearLogsMenu()">
                                <i class="fas fa-trash-alt"></i> Clear All (This Model)
                            </button>
                        </div>
                        <div style="padding: 8px;">
                            <button class="btn" style="width: 100%; background: #dc2626; justify-content: flex-start;" onclick="clearAllModels(); toggleClearLogsMenu()">
                                <i class="fas fa-exclamation-triangle"></i> Clear All (All Models)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body" style="padding: 0; display: flex; flex-direction: column; height: 600px;">
                <div id="logsScrollContainer" style="flex: 1; overflow-y: auto; border-bottom: 1px solid var(--border-color);">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 10;">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); width:50px;">#</th>
                                <th id="headerTime" style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="setSortColumn('time')">Time</th>
                                <th id="headerFile" style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="setSortColumn('file')">File</th>
                                <th id="headerSrcIP" style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="setSortColumn('srcip')">Src IP</th>
                                <th id="headerSrcPort" style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="setSortColumn('srcport')">Src Port</th>
                                <th id="headerDstIP" style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="setSortColumn('dstip')">Dst IP</th>
                                <th id="headerDstPort" style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="setSortColumn('dstport')">Dst Port</th>
                                <th id="headerPrediction" style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="setSortColumn('prediction')">Prediction</th>
                            </tr>
                            <tr style="background: var(--bg-secondary);">
                                <th style="padding: 6px; border-bottom: 1px solid var(--border-color);"></th>
                                <th style="padding: 6px; border-bottom: 1px solid var(--border-color);"><input id="filterTime" type="text" placeholder="Time" style="width:100%; padding:4px; font-size:0.75em; border:1px solid var(--border-color); border-radius:2px;"></th>
                                <th style="padding: 6px; border-bottom: 1px solid var(--border-color);"><input id="filterFile" type="text" placeholder="File" style="width:100%; padding:4px; font-size:0.75em; border:1px solid var(--border-color); border-radius:2px;"></th>
                                <th style="padding: 6px; border-bottom: 1px solid var(--border-color);"><input id="filterSrcIP" type="text" placeholder="Src IP" style="width:100%; padding:4px; font-size:0.75em; border:1px solid var(--border-color); border-radius:2px;"></th>
                                <th style="padding: 6px; border-bottom: 1px solid var(--border-color);"><input id="filterSrcPort" type="text" placeholder="Port" style="width:100%; padding:4px; font-size:0.75em; border:1px solid var(--border-color); border-radius:2px;"></th>
                                <th style="padding: 6px; border-bottom: 1px solid var(--border-color);"><input id="filterDstIP" type="text" placeholder="Dst IP" style="width:100%; padding:4px; font-size:0.75em; border:1px solid var(--border-color); border-radius:2px;"></th>
                                <th style="padding: 6px; border-bottom: 1px solid var(--border-color);"><input id="filterDstPort" type="text" placeholder="Port" style="width:100%; padding:4px; font-size:0.75em; border:1px solid var(--border-color); border-radius:2px;"></th>
                                <th style="padding: 6px; border-bottom: 1px solid var(--border-color);"><input id="filterPrediction" type="text" placeholder="Pred" style="width:100%; padding:4px; font-size:0.75em; border:1px solid var(--border-color); border-radius:2px;"></th>
                            </tr>
                        </thead>
                        <tbody id="modelLogsBody"></tbody>
                    </table>
                </div>
                <div id="logsLoadingIndicator" style="padding: 12px; text-align: center; color: var(--text-muted); display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
                <div id="paginationControls" style="padding:12px; display:flex; justify-content:center; gap:8px; align-items:center;">
                    <button class="btn" id="prevPageBtn" onclick="prevPage()" disabled>&lt; Prev</button>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span id="pageDisplay">Page 1 / 1</span>
                        <input id="pageInput" type="number" min="1" value="1" style="width:70px; padding:6px; border-radius:4px; border:1px solid var(--border-color);">
                        <button class="btn" onclick="gotoPage()">Go</button>
                    </div>
                    <button class="btn" id="nextPageBtn" onclick="nextPage()" disabled>Next &gt;</button>
                </div>
            </div>
        </div>
    </div>

    <!-- IPS Logs View -->
    <div id="view-ips-logs" class="view-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="margin: 0; color: var(--text-main);">IPS Detection Logs</h2>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="btn" onclick="loadIPSLogs()"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="btn" style="background: #ef4444;" onclick="clearIPSLogs()"><i class="fas fa-trash"></i> Clear Logs</button>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
            <div class="card" style="text-align: center; padding: 16px;">
                <div style="font-size: 2em; font-weight: 800; color: var(--text-main);" id="ips-stat-total">0</div>
                <div style="font-size: 0.9em; color: var(--text-muted);">Total Detections</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <div style="font-size: 2em; font-weight: 800; color: #ef4444;" id="ips-stat-critical">0</div>
                <div style="font-size: 0.9em; color: var(--text-muted);">Critical</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <div style="font-size: 2em; font-weight: 800; color: #f59e0b;" id="ips-stat-high">0</div>
                <div style="font-size: 0.9em; color: var(--text-muted);">High</div>
            </div>
            <div class="card" style="text-align: center; padding: 16px;">
                <div style="font-size: 2em; font-weight: 800; color: #3b82f6;" id="ips-stat-medium">0</div>
                <div style="font-size: 0.9em; color: var(--text-muted);">Medium/Low</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span>Detection Logs</span>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <select id="ipsLogsSeverityFilter" onchange="applyIPSLogsFilters()" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.85em; background: var(--bg-primary); color: var(--text-main);">
                        <option value="">All Severities</option>
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <input type="text" id="ipsLogsSearch" placeholder="Search..." onkeyup="debounceIPSLogsSearch()" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; width: 200px; font-size: 0.85em; background: var(--bg-primary); color: var(--text-main);">
                    <button class="btn" onclick="clearIPSLogsFilters()" style="padding: 6px 10px; font-size: 0.85em;"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="card-body" style="padding: 0; height: 500px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                        <tr>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSLogs('time')">#</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSLogs('time')">Time <span id="ipsLogsSortTime"></span></th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">File</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSLogs('src_ip')">Src IP <span id="ipsLogsSortSrcIp"></span></th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Src Port</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSLogs('dst_ip')">Dst IP <span id="ipsLogsSortDstIp"></span></th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Dst Port</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSLogs('rule_name')">Rule Matched <span id="ipsLogsSortRuleName"></span></th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSLogs('match_type')">Match Type <span id="ipsLogsSortMatchType"></span></th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSLogs('severity')">Severity <span id="ipsLogsSortSeverity"></span></th>
                        </tr>
                    </thead>
                    <tbody id="ipsLogsBody"></tbody>
                </table>
            </div>
            <!-- Pagination -->
            <div style="padding: 12px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color);">
                <span style="font-size: 0.85em; color: var(--text-muted);" id="ipsLogsInfo">Showing 0 of 0 logs</span>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn" id="ipsLogsPrevBtn" onclick="ipsLogsPrevPage()" disabled style="font-size: 0.85em; padding: 6px 12px;">&lt; Prev</button>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 0.85em;">Page</span>
                        <input type="number" id="ipsLogsPageInput" min="1" value="1" onkeypress="if(event.key==='Enter') ipsLogsGoToPage()" style="width: 50px; padding: 4px 6px; border: 1px solid var(--border-color); border-radius: 4px; text-align: center; font-size: 0.85em; background: var(--bg-primary); color: var(--text-main);">
                        <span style="font-size: 0.85em;">/ <span id="ipsLogsTotalPagesDisplay">1</span></span>
                        <button class="btn" onclick="ipsLogsGoToPage()" style="font-size: 0.8em; padding: 4px 8px;">Go</button>
                    </div>
                    <button class="btn" id="ipsLogsNextBtn" onclick="ipsLogsNextPage()" disabled style="font-size: 0.85em; padding: 6px 12px;">Next &gt;</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Summary View -->
    <div id="view-log-summary" class="view-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="margin: 0; color: var(--text-main);">Log Summary & Management</h2>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="btn" onclick="loadLogSummary()" style="background: #10b981;"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;" id="logSummaryStats"></div>

        <!-- Logs Summary Table -->
        <div class="card">
            <div class="card-header">
                <span>Logs Overview</span>
                <div style="display: flex; gap: 8px; margin-left: auto;">
                    <button class="btn" onclick="openBulkDeleteModal()" style="background: #ef4444;"><i class="fas fa-trash"></i> Bulk Delete</button>
                </div>
            </div>
            <div class="card-body" style="padding: 0; max-height: 600px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                        <tr>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color);">
                                <input type="checkbox" id="selectAllLogs" onchange="toggleSelectAllLogs(this)">
                            </th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color);">Log Type</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color);">Entries</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color);">Status</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color);">Last Updated</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color);">Action</th>
                        </tr>
                    </thead>
                    <tbody id="logSummaryTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-ips-database" class="view-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="margin: 0; color: var(--text-main);">IPS/IDS Rules Database</h2>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="ipsSearchBox" placeholder="Search rules..." onkeyup="syncIPSSearch(this)" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; width: 250px; background: var(--bg-primary); color: var(--text-main);">
                <button class="btn" onclick="toggleAddJA3Form()" style="background:#8b5cf6;"><i class="fas fa-fingerprint"></i> Add JA3 Rule</button>
                <button class="btn" onclick="loadIPSRules()"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
        </div>
        
        <!-- Add JA3/TLS Fingerprint Rule Form (Hidden by default) -->
        <div id="add-ja3-form" class="card" style="margin-bottom: 24px; display: none;">
            <div class="card-header">
                <span><i class="fas fa-fingerprint" style="color:#8b5cf6;"></i> Add TLS Fingerprint Rule (JA3/JA3S/SNI)</span>
                <button class="btn" onclick="toggleAddJA3Form()" style="padding:4px 8px; font-size:0.85em;"><i class="fas fa-times"></i></button>
            </div>
            <div class="card-body" style="padding: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="font-size: 0.85em; color: var(--text-muted); display: block; margin-bottom: 4px;">Rule Name <span style="color:#ef4444;">*</span></label>
                        <input type="text" id="ja3-rule-name" placeholder="e.g., Cobalt Strike JA3" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-main);">
                    </div>
                    <div>
                        <label style="font-size: 0.85em; color: var(--text-muted); display: block; margin-bottom: 4px;">Category</label>
                        <select id="ja3-rule-category" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-main);">
                            <option value="C2/Malware">C2/Malware</option>
                            <option value="Trojan Activity">Trojan Activity</option>
                            <option value="Backdoor">Backdoor</option>
                            <option value="Ransomware">Ransomware</option>
                            <option value="Phishing">Phishing</option>
                            <option value="Suspicious Traffic">Suspicious Traffic</option>
                            <option value="Policy Violation">Policy Violation</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.85em; color: var(--text-muted); display: block; margin-bottom: 4px;">JA3 Client Fingerprint (MD5)</label>
                        <input type="text" id="ja3-rule-ja3" placeholder="e.g., a0e9f5d64349fb13191bc781f81f42e1" maxlength="32" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-main); font-family: monospace;">
                    </div>
                    <div>
                        <label style="font-size: 0.85em; color: var(--text-muted); display: block; margin-bottom: 4px;">JA3S Server Fingerprint (MD5)</label>
                        <input type="text" id="ja3-rule-ja3s" placeholder="e.g., ae4edc6faf64d08308082ad26be60767" maxlength="32" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-main); font-family: monospace;">
                    </div>
                    <div>
                        <label style="font-size: 0.85em; color: var(--text-muted); display: block; margin-bottom: 4px;">SNI (Server Name)</label>
                        <input type="text" id="ja3-rule-sni" placeholder="e.g., malicious-domain.com" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-main);">
                    </div>
                    <div>
                        <label style="font-size: 0.85em; color: var(--text-muted); display: block; margin-bottom: 4px;">Severity <span style="color:#ef4444;">*</span></label>
                        <select id="ja3-rule-severity" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-main);">
                            <option value="Critical">Critical</option>
                            <option value="High" selected>High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 16px;">
                    <label style="font-size: 0.85em; color: var(--text-muted); display: block; margin-bottom: 4px;">Description</label>
                    <textarea id="ja3-rule-description" rows="2" placeholder="Description of this fingerprint rule..." style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-main); resize: vertical;"></textarea>
                </div>
                <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
                    <button class="btn" onclick="toggleAddJA3Form()" style="background: var(--bg-secondary); color: var(--text-main);">Cancel</button>
                    <button class="btn" onclick="addJA3Rule()" style="background: #8b5cf6;"><i class="fas fa-plus"></i> Add JA3 Rule</button>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; font-size: 0.85em; color: var(--text-muted);">
                    <i class="fas fa-info-circle" style="color:#8b5cf6;"></i> <strong>Tip:</strong> JA3 fingerprints are 32-character MD5 hashes. You can find known malicious JA3 fingerprints from threat intelligence sources like <a href="https://sslbl.abuse.ch/ja3-fingerprints/" target="_blank" style="color:#8b5cf6;">abuse.ch JA3 Fingerprints</a>.
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header"><span>Rules Statistics</span></div>
            <div class="card-body" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;">
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: 800; color: var(--text-main);" id="stat-total">0</div>
                    <div style="font-size: 0.9em; color: var(--text-muted);">Total Rules</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: 800; color: #ef4444;" id="stat-critical">0</div>
                    <div style="font-size: 0.9em; color: var(--text-muted);">Critical</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: 800; color: #f59e0b;" id="stat-high">0</div>
                    <div style="font-size: 0.9em; color: var(--text-muted);">High</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: 800; color: #3b82f6;" id="stat-medium">0</div>
                    <div style="font-size: 0.9em; color: var(--text-muted);">Medium</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: 800; color: #10b981;" id="stat-low">0</div>
                    <div style="font-size: 0.9em; color: var(--text-muted);">Low</div>
                </div>
            </div>
        </div>
        
        <!-- Rule Sources Section -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <span><i class="fas fa-satellite-dish"></i> Rule Sources</span>
                <button class="btn" onclick="refreshAllSources()" style="margin-left: auto; padding: 4px 10px; font-size: 0.85em;">
                    <i class="fas fa-sync-alt"></i> Refresh All
                </button>
            </div>
            <div class="card-body" style="padding: 12px;">
                <!-- Add New Source Form -->
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: 200px 1fr 120px 100px auto; gap: 10px; align-items: end;">
                        <div>
                            <label style="font-size: 0.8em; color: var(--text-muted); display: block; margin-bottom: 4px;">Source Name</label>
                            <input type="text" id="new-source-name" placeholder="Emerging Threats" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <div>
                            <label style="font-size: 0.8em; color: var(--text-muted); display: block; margin-bottom: 4px;">URL</label>
                            <input type="text" id="new-source-url" placeholder="https://rules.emergingthreats.net/open/snort-2.9.0/emerging-all.rules" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <div>
                            <label style="font-size: 0.8em; color: var(--text-muted); display: block; margin-bottom: 4px;">Interval (min)</label>
                            <input type="number" id="new-source-interval" value="10" min="1" max="1440" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <div>
                            <label style="font-size: 0.8em; color: var(--text-muted); display: block; margin-bottom: 4px;">Auto Refresh</label>
                            <select id="new-source-auto-refresh" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9em;">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <button class="btn" onclick="addNewSource()" style="padding: 8px 16px;">
                            <i class="fas fa-plus"></i> Add Source
                        </button>
                    </div>
                </div>
                
                <!-- Sources Table -->
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                        <tr style="background: var(--bg-secondary);">
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Status</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Name</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">URL</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color);">Interval</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color);">Rules</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Last Update</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color);">Enabled</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color);">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ips-sources-body">
                        <tr><td colspan="8" style="padding: 20px; text-align: center; color: var(--text-muted);">Loading sources...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header"><span>Import Rules (Manual)</span></div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- File Upload -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--text-main);">Upload Rules File</h4>
                        <p style="color: var(--text-muted); font-size: 0.9em;">Import rules from CSV file or Snort/Suricata .rules file</p>
                        <div style="display: flex; gap: 8px;">
                            <label for="ips-import-file" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 12px; border: 2px dashed var(--border-color); border-radius: 6px; cursor: pointer; background: var(--bg-secondary); transition: all 0.3s;">
                                <span id="ips-import-file-label" style="color: var(--text-muted); font-weight: 500;">Choose .csv or .rules file</span>
                                <input type="file" id="ips-import-file" accept=".csv,.rules" style="display: none;" />
                            </label>
                            <button class="btn" onclick="importIPSRulesFromFile()" style="white-space: nowrap;">
                                <i class="fas fa-upload"></i> Import
                            </button>
                        </div>
                    </div>
                    
                    <!-- URL Import (Manual - no source tracking) -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--text-main);">Quick Import from URL</h4>
                        <p style="color: var(--text-muted); font-size: 0.9em;">One-time import without source tracking</p>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="ips-import-url" placeholder="https://example.com/rules.csv" style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px;" />
                            <button class="btn" onclick="importIPSRulesFromURL()" style="white-space: nowrap;">
                                <i class="fas fa-globe"></i> Import
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <span>IPS Rules</span>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <select id="ipsSeverityFilter" onchange="applyIPSFilters()" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.85em; background: var(--bg-primary); color: var(--text-main);">
                        <option value="">All Severities</option>
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <input type="text" id="ipsRulesSearch" placeholder="Search rules..." onkeyup="syncIPSSearch(this)" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; width: 200px; font-size: 0.85em; background: var(--bg-primary); color: var(--text-main);">
                    <button class="btn" onclick="clearIPSFilters()" style="padding: 6px 10px; font-size: 0.85em;"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="card-body" style="padding: 0; height: 500px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                        <tr>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSRules('rule_id')">Rule ID <span id="ipsSortRuleId"></span></th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSRules('rule_name')">Rule Name <span id="ipsSortRuleName"></span></th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSRules('category')">Category <span id="ipsSortCategory"></span></th>
                            <th style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="sortIPSRules('severity')">Severity <span id="ipsSortSeverity"></span></th>
                            <th style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color);">Source</th>
                        </tr>
                    </thead>
                    <tbody id="ipsRulesBody" style="cursor: pointer;"></tbody>
                </table>
            </div>
            <!-- Pagination -->
            <div style="padding: 12px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color);">
                <span style="font-size: 0.85em; color: var(--text-muted);" id="ipsRulesInfo">Showing 0 of 0 rules</span>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn" id="ipsPrevBtn" onclick="ipsPrevPage()" disabled style="font-size: 0.85em; padding: 6px 12px;">&lt; Prev</button>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 0.85em;">Page</span>
                        <input type="number" id="ipsPageInput" min="1" value="1" onkeypress="if(event.key==='Enter') ipsGoToPage()" style="width: 50px; padding: 4px 6px; border: 1px solid var(--border-color); border-radius: 4px; text-align: center; font-size: 0.85em; background: var(--bg-primary); color: var(--text-main);">
                        <span style="font-size: 0.85em;">/ <span id="ipsTotalPagesDisplay">1</span></span>
                        <button class="btn" onclick="ipsGoToPage()" style="font-size: 0.8em; padding: 4px 8px;">Go</button>
                    </div>
                    <button class="btn" id="ipsNextBtn" onclick="ipsNextPage()" disabled style="font-size: 0.85em; padding: 6px 12px;">Next &gt;</button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Logs View -->
    <div id="view-system-logs" class="view-section">
        <h2 style="margin-bottom: 24px; color: var(--text-main);">System Logs</h2>
        
        <div class="card">
            <div class="card-header">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button id="syslog-tab-api" class="btn" style="background: var(--text-main); color: white;" onclick="switchSysLogTab('api')">
                        <i class="fas fa-code"></i> API Calls
                    </button>
                    <button id="syslog-tab-login" class="btn" style="background: var(--bg-secondary);" onclick="switchSysLogTab('login')">
                        <i class="fas fa-user-check"></i> User Logins
                    </button>
                    <button id="syslog-tab-system" class="btn" style="background: var(--bg-secondary);" onclick="switchSysLogTab('system')">
                        <i class="fas fa-microchip"></i> System Metrics
                    </button>
                    <button class="btn" style="margin-left: auto;" onclick="loadSystemLogs()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- API Calls Tab -->
            <div id="syslog-api-panel" class="card-body" style="padding: 0;">
                <div style="padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; gap: 8px;">
                    <input type="text" id="apiSearchInput" placeholder="Search API..." onkeyup="filterAPILogs()" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; flex: 1; background: var(--bg-primary); color: var(--text-main);">
                    <select id="apiMethodFilter" onchange="filterAPILogs()" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-main);">
                        <option value="">All Methods</option>
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                </div>
                <div style="height: 500px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Time</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Method</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Endpoint</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">User</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Status</th>
                            </tr>
                        </thead>
                        <tbody id="apiLogsBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- User Logins Tab -->
            <div id="syslog-login-panel" class="card-body" style="padding: 0; display: none;">
                <div style="padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; gap: 8px;">
                    <input type="text" id="loginSearchInput" placeholder="Search username..." onkeyup="filterLoginLogs()" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; flex: 1; background: var(--bg-primary); color: var(--text-main);">
                    <select id="loginStatusFilter" onchange="filterLoginLogs()" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-main);">
                        <option value="">All Status</option>
                        <option value="success">Success</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                <div style="height: 500px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Time</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Username</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">IP Address</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Status</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Details</th>
                            </tr>
                        </thead>
                        <tbody id="loginLogsBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- System Metrics Tab -->
            <div id="syslog-system-panel" class="card-body" style="padding: 0; display: none;">
                <div style="padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; gap: 8px;">
                    <select id="systemTypeFilter" onchange="filterSystemLogs()" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-main);">
                        <option value="">All Types</option>
                        <option value="cpu">CPU</option>
                        <option value="memory">Memory</option>
                        <option value="disk">Disk</option>
                        <option value="error">Error</option>
                    </select>
                </div>
                <div style="height: 500px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Time</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Type</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Value</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color);">Status</th>
                            </tr>
                        </thead>
                        <tbody id="systemLogsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

                <div class="slide-overlay" id="panelOverlay" onclick="closeDetails()"></div>
    <div class="forti-panel" id="logDetailPanel">
        <div class="forti-header">
            <span id="detailPanelTitle"><i class="fas fa-list-alt" style="color:var(--text-main); margin-right:8px;"></i> Details</span>
            <button class="close-panel-btn" onclick="closeDetails()">&times;</button>
        </div>
        <div class="forti-content" id="panelContent">
            </div>
    </div>

    <!-- Delete Evidence PCAP Modal -->
    <div id="deleteEvidenceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: var(--bg-main); border-radius: 12px; padding: 24px; width: 400px; max-width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #ef4444;"><i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>Delete Evidence</h3>
                <button onclick="closeDeleteEvidenceModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <p style="margin: 0 0 12px 0; color: var(--text-main);">
                    <strong>Warning:</strong> You are about to permanently delete an evidence PCAP file.
                </p>
                <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                    <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">
                        <i class="fas fa-file"></i> File to delete:
                    </div>
                    <div id="deleteEvidenceFilename" style="color: #78350f; font-family: monospace;"></div>
                </div>
                <p style="margin: 0; font-size: 0.9em; color: var(--text-muted);">
                    This action cannot be undone. Please enter your password to confirm.
                </p>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main);">
                    <i class="fas fa-lock" style="margin-right: 6px;"></i>Confirm Password
                </label>
                <input type="password" id="deleteEvidencePassword" placeholder="Enter your password" 
                    style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-main); font-size: 1em;"
                    onkeypress="if(event.key==='Enter') executeDeleteEvidence()">
            </div>
            <div style="display: flex; gap: 12px;">
                <button onclick="closeDeleteEvidenceModal()" class="btn" style="flex: 1; background: var(--bg-secondary);">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button onclick="executeDeleteEvidence()" class="btn" style="flex: 1; background: #ef4444;">
                    <i class="fas fa-trash"></i> Delete Permanently
                </button>
            </div>
        </div>
    </div>
{% endblock %}